# 📊 後台管理與 Google Sheets 對應關係優化說明

## 🎯 優化目標

在不影響現有功能的情況下，優化後台管理系統與 Google Sheets 之間的數據對應關係，並添加 LINE 名稱編輯功能。

## 📋 當前數據結構

### Sheet1 (電話查詢記錄)
- **列 W (索引 22)**: `displayName` - LINE 顯示名稱
- **列 LA (索引 37)**: `LINE名稱` - LINE 名稱
- **列 UA (索引 46)**: `profileUrl` - LINE 頭像 URL

### Members / Subscriptions (會員管理)
- **列 A (索引 0)**: `userId` - LINE User ID
- **列 B (索引 1)**: `plan` - 會員方案
- **列 C (索引 2)**: `status` - 會員狀態
- **列 D (索引 3)**: `startAt` - 開始時間
- **列 E (索引 4)**: `expireAt` - 到期時間
- **列 F (索引 5)**: `LINE名稱` - LINE 名稱 ⭐ **可編輯**

## ✅ 已完成的優化

### 1. 數據映射關係優化

**之前**：
- Members 工作表的 LINE 名稱只能從 Sheet1 關聯獲取
- 無法在後台直接編輯 LINE 名稱

**現在**：
- Members 工作表的 LINE 名稱可以獨立編輯
- 後台管理系統會優先顯示 Members 工作表的 LINE 名稱
- 如果 Members 工作表沒有 LINE 名稱，則從 Sheet1 的 displayName 獲取

### 2. 編輯功能增強

**新增功能**：
- ✅ 可以同時編輯：方案、狀態、LINE 名稱
- ✅ LINE 名稱會即時同步到 Google Sheets
- ✅ 編輯時保持其他欄位（startAt, expireAt）不變

**編輯流程**：
1. 點擊會員的「編輯」按鈕
2. 在編輯模式下：
   - LINE 資訊列：顯示輸入框，可編輯 LINE 名稱
   - 方案列：顯示下拉選單，可選擇方案
   - 狀態列：顯示下拉選單，可選擇狀態
3. 點擊「儲存」按鈕
4. 數據即時同步到 Google Sheets

### 3. 數據同步邏輯

**優化前**：
```typescript
// 只更新方案和狀態
updateMember(rowNumber, plan, status)
```

**優化後**：
```typescript
// 可以同時更新方案、狀態和 LINE 名稱
updateMember(rowNumber, plan, status, lineName)
```

**同步策略**：
- 如果提供 `lineName`，會同時更新 B、C、F 列（plan, status, LINE名稱）
- 更新時會先讀取 D、E 列（startAt, expireAt）的值，確保不丟失
- 如果未提供 `lineName`，只更新 B、C 列（plan, status）

## 🔄 數據流向

```
後台管理系統
    ↓
編輯會員資訊（方案、狀態、LINE名稱）
    ↓
API: PUT /api/members
    ↓
updateMember() 函數
    ↓
Google Sheets API
    ↓
Members / Subscriptions 工作表
    ↓
即時同步 ✅
```

## 📝 使用方式

### 編輯 LINE 名稱

1. 打開後台管理系統
2. 進入「會員管理」頁面
3. 找到要編輯的會員
4. 點擊「編輯」按鈕
5. 在「LINE 資訊」列的輸入框中輸入新的 LINE 名稱
6. 點擊「儲存」按鈕
7. LINE 名稱會即時同步到 Google Sheets

### 數據顯示優先級

1. **優先顯示**：Members 工作表的 `LINE名稱` (列 F)
2. **備選顯示**：Sheet1 的 `displayName` (列 W)
3. **預設顯示**：「未設定」

## ⚠️ 注意事項

1. **數據一致性**：
   - Members 工作表的 LINE 名稱是主要數據源
   - Sheet1 的 displayName 作為備選數據源
   - 編輯 Members 工作表的 LINE 名稱不會影響 Sheet1

2. **現有功能保持不變**：
   - ✅ 所有現有的讀取功能正常運作
   - ✅ 方案和狀態編輯功能正常運作
   - ✅ 數據統計功能正常運作
   - ✅ 電話查詢記錄功能正常運作

3. **權限要求**：
   - 服務帳號需要有「編輯者」權限
   - 已確認編輯權限正常 ✅

## 🎉 優化成果

- ✅ 優化了數據映射關係
- ✅ 添加了 LINE 名稱編輯功能
- ✅ 保持了所有現有功能
- ✅ 提升了數據管理靈活性
- ✅ 改善了用戶體驗
