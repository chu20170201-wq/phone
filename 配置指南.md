# Google Sheets API 配置详细步骤

## 📋 前置准备
- 一个 Google 账号（可以使用 `chu20170201@gmail.com`）
- 访问 Google Sheets 的权限

## 🚀 步骤 1: 创建 Google Cloud 项目

1. 访问 [Google Cloud Console](https://console.cloud.google.com/)
2. 使用你的 Google 账号登录（`chu20170201@gmail.com`）
3. 点击页面顶部的项目选择器
4. 点击「新建项目」
5. 输入项目名称（例如：`phone-query-admin`）
6. 点击「创建」
7. 等待项目创建完成（约 10-30 秒）

## 🔧 步骤 2: 启用 Google Sheets API

1. 在 Google Cloud Console 中，点击左侧菜单的「API 和服务」>「库」
2. 在搜索框中输入「Google Sheets API」
3. 点击「Google Sheets API」
4. 点击「启用」按钮
5. 等待启用完成

## 👤 步骤 3: 创建服务账号

1. 在左侧菜单中，点击「IAM 和管理」>「服务账号」
2. 点击页面顶部的「+ 创建服务账号」按钮
3. 填写信息：
   - **服务账号名称**：`phone-query-admin-service`（可以自定义）
   - **服务账号 ID**：会自动生成（可以保持默认）
   - **说明**：`用于访问电话查询系统的 Google Sheets`
4. 点击「创建并继续」
5. 在「授予此服务账号对项目的访问权限」步骤中：
   - **角色**：可以选择「无」（因为我们只需要访问 Sheets，不需要项目权限）
   - 或者直接点击「继续」跳过
6. 点击「完成」

## 🔑 步骤 4: 创建并下载密钥

1. 在服务账号列表中，找到刚创建的服务账号
2. 点击服务账号的邮箱地址（格式类似：`phone-query-admin-service@项目名.iam.gserviceaccount.com`）
3. 点击「密钥」标签
4. 点击「添加密钥」>「创建新密钥」
5. 选择「JSON」格式
6. 点击「创建」
7. **重要**：JSON 文件会自动下载到你的电脑，请保存好这个文件！

## 📄 步骤 5: 获取配置信息

打开下载的 JSON 文件，你会看到类似这样的内容：

```json
{
  "type": "service_account",
  "project_id": "your-project-id",
  "private_key_id": "...",
  "private_key": "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n",
  "client_email": "phone-query-admin-service@your-project.iam.gserviceaccount.com",
  "client_id": "...",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  ...
}
```

你需要记录：
- **client_email**：服务账号邮箱（例如：`phone-query-admin-service@xxx.iam.gserviceaccount.com`）
- **private_key**：私钥（整个 `-----BEGIN PRIVATE KEY-----` 到 `-----END PRIVATE KEY-----` 之间的内容）

## 🔗 步骤 6: 分享 Google Sheets 给服务账号

1. 打开你的 Google Sheets：
   https://docs.google.com/spreadsheets/d/1VulDP7Kk_Uirag_ggRb042FI4n0BV7ntEkjsyWSI9V0/edit

2. 点击右上角的「分享」按钮

3. 在「添加用户和群组」输入框中，粘贴服务账号的邮箱地址（从 JSON 文件的 `client_email`）

4. 权限选择「查看者」或「编辑者」（建议选择「查看者」即可，因为后台只需要读取数据）

5. 取消勾选「通知用户」（因为这是机器人账号，不需要通知）

6. 点击「分享」

## ⚙️ 步骤 7: 配置环境变量

现在需要将信息填入 `.env.local` 文件：

1. 打开项目目录中的 `.env.local` 文件

2. 填入以下信息：
   - `GOOGLE_SHEETS_SPREADSHEET_ID`：已经设置好了（`1VulDP7Kk_Uirag_ggRb042FI4n0BV7ntEkjsyWSI9V0`）
   - `GOOGLE_SERVICE_ACCOUNT_EMAIL`：从 JSON 文件复制 `client_email` 的值
   - `GOOGLE_PRIVATE_KEY`：从 JSON 文件复制 `private_key` 的值，**注意**：
     - 需要保留整个私钥，包括 `-----BEGIN PRIVATE KEY-----` 和 `-----END PRIVATE KEY-----`
     - 需要保留换行符 `\n`
     - 建议用双引号包裹整个私钥

示例格式：
```env
GOOGLE_SHEETS_SPREADSHEET_ID=1VulDP7Kk_Uirag_ggRb042FI4n0BV7ntEkjsyWSI9V0
GOOGLE_SERVICE_ACCOUNT_EMAIL=phone-query-admin-service@your-project.iam.gserviceaccount.com
GOOGLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC...\n-----END PRIVATE KEY-----\n"
```

## ✅ 步骤 8: 重启开发服务器

配置完成后，需要重启开发服务器：

1. 停止当前的开发服务器（在终端按 `Ctrl + C`）
2. 重新运行：`npm run dev`
3. 访问 http://localhost:3000 测试

## 🐛 常见问题

### 问题 1: 无法访问 Google Sheets
- ✅ 检查服务账号是否已分享到 Google Sheets
- ✅ 检查服务账号的权限是否为「查看者」或「编辑者」

### 问题 2: 认证失败
- ✅ 检查 `GOOGLE_PRIVATE_KEY` 是否正确（需要包含完整的 `-----BEGIN PRIVATE KEY-----` 和 `-----END PRIVATE KEY-----`）
- ✅ 检查 `GOOGLE_SERVICE_ACCOUNT_EMAIL` 是否正确
- ✅ 确保私钥中的换行符 `\n` 被正确保留

### 问题 3: 数据不显示
- ✅ 检查工作表名称是否正确（应该是 `Sheet1` 和 `Members / Subscriptions`）
- ✅ 查看浏览器控制台（F12）的错误信息
- ✅ 查看终端中的服务器错误日志

## 📞 需要帮助？

如果遇到问题，请提供：
1. 错误信息（从浏览器控制台或终端）
2. `.env.local` 文件的前几行（隐藏私钥内容）
3. 你执行到哪个步骤了
